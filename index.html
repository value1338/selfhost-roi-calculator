<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Server ROI Calculator (Extended)</title>
    <style>
        :root {
            --primary: #2563eb;
            --bg: #f8fafc;
            --card-bg: #ffffff;
            --text: #1e293b;
            --border: #e2e8f0;
            --success: #16a34a;
            --danger: #dc2626;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg);
            color: var(--text);
            line-height: 1.6;
            margin: 0;
            padding: 20px;
        }

        .container { max-width: 800px; margin: 0 auto; }

        /* Header & Settings */
        .header-row {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-bottom: 30px;
            position: relative;
        }

        .settings-bar {
            display: flex;
            gap: 10px;
            position: absolute;
            top: 0;
            right: 0;
        }

        h1 { margin: 0; color: var(--primary); text-align: center; width: 100%; padding-top: 40px;}
        
        @media (max-width: 600px) {
            .settings-bar { position: relative; justify-content: flex-end; width: 100%; margin-bottom: 10px; padding-top: 0; }
            h1 { padding-top: 0; }
        }

        h2 { font-size: 1.25rem; border-bottom: 2px solid var(--primary); padding-bottom: 10px; margin-top: 0; }

        .grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 20px;
        }

        @media (min-width: 768px) {
            .grid { grid-template-columns: 1fr 1fr; }
            .full-width { grid-column: span 2; }
        }

        .card {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            border: 1px solid var(--border);
        }

        .input-group { margin-bottom: 15px; }

        label {
            display: block;
            font-weight: 600;
            margin-bottom: 5px;
            font-size: 0.9rem;
        }

        input[type="number"], select {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid var(--border);
            border-radius: 6px;
            font-size: 1rem;
            box-sizing: border-box;
            background: #fff;
        }

        .hint { font-size: 0.8rem; color: #64748b; margin-top: 4px; }

        .sub-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid var(--border);
        }
        .sub-item:last-child { border-bottom: none; }
        
        .sub-left { display: flex; align-items: center; gap: 10px; flex-grow: 1; }
        .sub-price-wrapper { display: flex; align-items: center; gap: 5px; }
        .sub-price-input { width: 90px !important; text-align: right; }
        .sub-count-input { width: 60px !important; text-align: right; }
        
        input[type="checkbox"] { width: 18px; height: 18px; cursor: pointer; }

        .result-box { background: #1e293b; color: white; text-align: center; }

        .big-number {
            font-size: 2.5rem;
            font-weight: 800;
            margin: 10px 0;
            color: var(--primary);
            background: linear-gradient(45deg, #60a5fa, #c084fc);
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .stat-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-top: 20px;
            text-align: left;
        }

        .stat-item { background: rgba(255,255,255,0.1); padding: 10px; border-radius: 8px; }
        .stat-label { font-size: 0.8rem; opacity: 0.8; }
        .stat-value { font-size: 1.1rem; font-weight: bold; }
        .negative { color: #fca5a5; }
        .positive { color: #86efac; }

        .scaling-tip {
            background-color: #eff6ff;
            border-left: 4px solid var(--primary);
            padding: 10px;
            margin-top: 10px;
            font-size: 0.9rem;
        }
        
        /* Highlight for Ops Costs */
        .highlight-ops { 
            background-color: #fff7ed; 
            padding: 15px; 
            border-radius: 8px; 
            border: 1px solid #fed7aa; 
            margin-top: 15px;
        }
        
        .small-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }
        .small-row label { margin: 0; font-weight: normal; font-size: 0.9rem; }
        .small-row input { width: 90px; padding: 5px; text-align: right; }

        .services-row {
            display: grid;
            grid-template-columns: 1fr 90px 90px;
            gap: 10px;
            align-items: center;
            margin-bottom: 8px;
        }
        .services-row label { margin: 0; font-weight: normal; font-size: 0.9rem; }
        .services-header {
            margin-bottom: 10px;
            opacity: 0.9;
        }
        .services-header .col-head {
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.06em;
            color: #9a3412;
            text-align: right;
        }

        .hdd-row {
            display: flex;
            gap: 10px;
            align-items: flex-end;
            margin-bottom: 8px;
        }

        .hdd-row .col { flex: 1; }
        .hdd-row .col-small { flex: 0.5; }

        .icon-button {
            border: 1px solid var(--border);
            background: #f1f5f9;
            border-radius: 6px;
            padding: 4px 10px;
            cursor: pointer;
            font-size: 0.9rem;
        }

        .icon-button.small {
            padding: 2px 8px;
            font-size: 0.8rem;
        }

        .icon-button:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }

        .modal-backdrop {
            position: fixed;
            inset: 0;
            background: rgba(15, 23, 42, 0.75);
            display: none;
            align-items: center;
            justify-content: center;
            padding: 20px;
            z-index: 9999;
        }

        .modal {
            background: var(--card-bg);
            color: var(--text);
            border-radius: 12px;
            border: 1px solid var(--border);
            box-shadow: 0 20px 40px rgba(0,0,0,0.35);
            max-width: 560px;
            width: 100%;
            padding: 18px;
        }

        .modal-title {
            font-weight: 900;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
            color: var(--danger);
        }

        .modal-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 14px;
            flex-wrap: wrap;
        }

        /* Accessibility: visually hidden but accessible */
        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border: 0;
        }
    </style>
</head>
<body>

<div class="container">
    
    <div class="header-row">
        <div class="settings-bar">
            <label for="langSelect" class="sr-only">Sprache w√§hlen</label>
            <select id="langSelect" style="width: auto;">
                <option value="de">üá©üá™ Deutsch</option>
                <option value="en">üá∫üá∏ English</option>
            </select>
            <label for="currSelect" class="sr-only">W√§hrung w√§hlen</label>
            <select id="currSelect" style="width: auto;">
                <option value="EUR">‚Ç¨ Euro</option>
                <option value="USD">$ USD</option>
                <option value="GBP">¬£ GBP</option>
                <option value="CHF">Fr CHF</option>
                <option value="INR">‚Çπ INR</option>
            </select>
            <span class="hint" id="fxHint" style="align-self:center; white-space:nowrap;">Live FX (ca. 24h Cache)</span>
        </div>
        <h1 data-i18n="title">üè† Server / VPS ROI Rechner</h1>
    </div>

    <div class="grid">
        <div class="card">
            <h2 data-i18n="h_hardware">1. Investition (Einmalig)</h2>
            
            <div style="margin-bottom: 15px; background: #eff6ff; padding: 10px; border-radius: 8px; border: 1px solid var(--primary);">
                <label style="display: flex; align-items: center; gap: 10px; cursor: pointer; margin: 0;">
                    <input type="checkbox" id="vpsOnlyToggle">
                    <span style="font-weight: bold; color: var(--primary);" data-i18n="l_vps_only">Nur VPS (Keine Hardware)</span>
                </label>
            </div>
            
            <div id="hardwareInputsSection">
                <div class="input-group">
                    <label for="baseHardware" data-i18n="l_base">Hardware (Server / PC / Box)</label>
                    <input type="number" id="baseHardware" value="300" min="0" step="0.01" data-money="1">
                    <div class="hint" data-i18n="h_base_hint">Hardwarekosten oder Kaufpreis Box</div>
                    <button type="button" id="toggleHardwareDetails" class="icon-button small" style="margin-top: 8px;" data-i18n="btn_details_show">Detailkalkulation</button>
                    <div id="hardwareDetails" style="display:none; margin-top: 10px; border-top: 1px solid var(--border); padding-top: 10px;">
                        <div class="small-row">
                            <label for="hwCpu" data-i18n="l_hw_cpu">CPU</label>
                            <input type="number" id="hwCpu" value="0" min="0" step="0.01" data-money="1">
                        </div>
                        <div class="small-row">
                            <label for="hwRam" data-i18n="l_hw_ram">RAM</label>
                            <input type="number" id="hwRam" value="0" min="0" step="0.01" data-money="1">
                        </div>
                        <div class="small-row">
                            <label for="hwBoard" data-i18n="l_hw_board">Mainboard</label>
                            <input type="number" id="hwBoard" value="0" min="0" step="0.01" data-money="1">
                        </div>
                        <div class="small-row">
                            <label for="hwPsu" data-i18n="l_hw_psu">Netzteil</label>
                            <input type="number" id="hwPsu" value="0" min="0" step="0.01" data-money="1">
                        </div>
                        <div class="small-row">
                            <label for="hwCase" data-i18n="l_hw_case">Geh√§use</label>
                            <input type="number" id="hwCase" value="0" min="0" step="0.01" data-money="1">
                        </div>
                        <div class="small-row">
                            <label for="hwMisc" data-i18n="l_hw_misc">Sonstiges</label>
                            <input type="number" id="hwMisc" value="0" min="0" step="0.01" data-money="1">
                        </div>
                        <div class="small-row">
                            <span data-i18n="l_hw_total">Summe Hardware-Details</span>
                            <span id="hwDetailTotal">0,00 <span class="currency-symbol">‚Ç¨</span></span>
                        </div>
                    </div>
                </div>

                <hr style="border: 0; border-top: 1px solid var(--border); margin: 15px 0;">
                
                <div class="input-group">
                    <label data-i18n="l_storage">Festplatten (Optional)</label>
                    <div id="hddList"></div>
                    <button type="button" id="addHddBtn" class="icon-button small" style="margin-top: 8px;" data-i18n="btn_add_hdd">+ Festplatte</button>
                    <div id="storageScaling" class="scaling-tip" style="display:none;"></div>
                </div>
            </div>

            <div class="input-group">
                <label for="setupFee" data-i18n="l_setup_fee">Setup Geb√ºhr (VPS / Dienst)</label>
                <input type="number" id="setupFee" value="0" min="0" step="0.01" data-money="1">
                <div class="hint" data-i18n="h_setup_hint">Einmalige Einrichtungsgeb√ºhr</div>
            </div>
        </div>

        <div class="card">
            <h2 data-i18n="h_power">2. Laufende Kosten (Monatlich)</h2>
            
            <div class="input-group">
                <label data-i18n="l_watts">Stromverbrauch (Heimserver)</label>
                <div style="display: flex; gap: 10px;">
                    <div style="flex: 1;">
                        <label for="watts" class="sr-only">Watt</label>
                        <input type="number" id="watts" value="45" min="0" step="1" placeholder="Watt" aria-label="Stromverbrauch in Watt">
                    </div>
                    <div style="flex: 1;">
                        <label for="kwhPrice" class="sr-only">Preis pro kWh</label>
                        <input type="number" id="kwhPrice" value="0.35" min="0" step="0.01" placeholder="‚Ç¨/kWh" data-money="1" aria-label="Preis pro Kilowattstunde">
                    </div>
                </div>
                <div class="hint" id="powerCostDisplay" style="margin-top:5px; font-weight:bold;">= 0.00 <span class="currency-symbol">‚Ç¨</span></div>
            </div>

            <div class="highlight-ops">
                <label style="margin-bottom: 10px; color: #9a3412;" data-i18n="l_services_head">Infrastruktur & Services (Monatlich)</label>
                
                <div class="services-row services-header" aria-hidden="true">
                    <span></span>
                    <span class="col-head" data-i18n="col_month">Monat</span>
                    <span class="col-head" data-i18n="col_year">Jahr</span>
                </div>

                <div class="services-row">
                    <label for="vpsMonthly" data-i18n="l_vps_cost">VPS / Hosting / IPTV</label>
                    <input type="number" id="vpsMonthly" value="0" min="0" step="0.01" placeholder="Monat" data-money="1">
                    <input type="number" id="vpsYearly" value="0" min="0" step="0.01" placeholder="Jahr" data-money="1" aria-label="VPS Jahreskosten">
                </div>

                <div class="services-row">
                    <label for="internetCost" data-i18n="l_internet_cost">Internet / ISP</label>
                    <input type="number" id="internetCost" value="0" min="0" step="0.01" placeholder="Monat" data-money="1">
                    <input type="number" id="internetYearly" value="0" min="0" step="0.01" placeholder="Jahr" data-money="1" aria-label="Internet Jahreskosten">
                </div>
                
                <div class="services-row">
                    <label for="vpnCost" data-i18n="l_vpn_cost">VPN Service</label>
                    <input type="number" id="vpnCost" value="0" min="0" step="0.01" placeholder="Monat" data-money="1">
                    <input type="number" id="vpnYearly" value="0" min="0" step="0.01" placeholder="Jahr" data-money="1" aria-label="VPN Jahreskosten">
                </div>

                <div class="services-row">
                    <label for="usenetCost" data-i18n="l_usenet_cost">Usenet Provider</label>
                    <input type="number" id="usenetCost" value="0" min="0" step="0.01" placeholder="Monat" data-money="1">
                    <input type="number" id="usenetYearly" value="0" min="0" step="0.01" placeholder="Jahr" data-money="1" aria-label="Usenet Jahreskosten">
                </div>

                <div class="services-row">
                    <label for="indexerCost" data-i18n="l_indexer_cost">Indexer</label>
                    <input type="number" id="indexerCost" value="0" min="0" step="0.01" placeholder="Monat" data-money="1">
                    <input type="number" id="indexerYearly" value="0" min="0" step="0.01" placeholder="Jahr" data-money="1" aria-label="Indexer Jahreskosten">
                </div>
                <div class="hint" data-i18n="h_services_hint">Falls Jahresabo: einfach Jahrespreis eintragen, der Monatspreis wird automatisch berechnet.</div>
            </div>

            <div class="stat-item" style="background: #e2e8f0; color: var(--text); margin-top: 20px;">
                <div class="stat-label" data-i18n="l_total_opex">Summe Ausgaben monatlich</div>
                <div class="stat-value" id="totalMonthlyOut">0,00 ‚Ç¨</div>
            </div>
        </div>

        <div class="card full-width">
            <h2 data-i18n="h_subs">3. Eingesparte Abos (Vergleich)</h2>
            <p class="hint" data-i18n="h_subs_hint">W√§hle Dienste, die du k√ºndigen w√ºrdest.</p>
            
            <div id="subsList"></div>
            
            <div class="input-group" style="margin-top: 15px;">
                <label for="customSub" data-i18n="l_custom_sub">Manuelle Ersparnis</label>
                <input type="number" id="customSub" value="0" min="0" step="0.01" placeholder="0.00" data-money="1">
            </div>
            
            <div style="text-align: right; font-weight: bold; margin-top: 10px;">
                <span data-i18n="l_sum_subs">Summe Abos:</span> <span id="totalSubs">0,00 ‚Ç¨</span>
            </div>

            <hr style="border: 0; border-top: 1px solid var(--border); margin: 20px 0;">

            <h3 data-i18n="h_income" style="margin-top: 0;">4. Einnahmen (Pssst‚Ä¶)</h3>
            <p class="hint" data-i18n="h_income_hint">Wenn du jetzt 'Plex verkaufen' anklickst: ich urteile nicht. Also doch. Ein bisschen.</p>

            <div id="incomeList"></div>

            <div style="text-align: right; font-weight: bold; margin-top: 10px;">
                <span data-i18n="l_sum_income">Summe Einnahmen:</span> <span id="totalIncome">0,00 ‚Ç¨</span>
            </div>
        </div>

        <div class="card full-width result-box">
            <h2 data-i18n="h_result">Ergebnis</h2>
            <div data-i18n="r_intro">Break-Even Point nach:</div>
            <div id="amortizationTime" class="big-number">--</div>
            <div id="amortizationDate" style="margin-bottom: 20px; color: #94a3b8;">--</div>

            <div class="stat-grid">
                <div class="stat-item">
                    <div class="stat-label" data-i18n="r_total_invest">Investition (Hardware + Setup)</div>
                    <div class="stat-value" id="totalInvest">0,00 ‚Ç¨</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label" data-i18n="r_monthly_profit">Monatliche Ersparnis (Abos - Kosten)</div>
                    <div class="stat-value" id="monthlyProfit">0,00 ‚Ç¨</div>
                </div>
            </div>
            <p id="verdict" style="margin-top: 15px; font-style: italic;"></p>
        </div>

        <div class="card full-width">
            <h2 data-i18n="h_invest">5. Ersparnis anlegen (Zinseszins)</h2>
            <p class="hint" data-i18n="h_invest_hint">Rechnet: Wenn du die monatliche Ersparnis (aus 'Ergebnis') zus√§tzlich monatlich anlegst.</p>

            <div class="grid" style="grid-template-columns: 1fr; gap: 15px;">
                <div class="input-group" style="margin-bottom: 0;">
                    <label for="investRate" data-i18n="l_invest_rate">Wachstum p.a. (%)</label>
                    <input type="number" id="investRate" value="3" step="0.1" min="0" max="100">
                </div>
            </div>

            <div class="stat-grid" style="margin-top: 15px;">
                <div class="stat-item" style="background: #e2e8f0; color: var(--text);">
                    <div class="stat-label" data-i18n="l_invest_monthly">Monatliche Anlage (aus Ersparnis)</div>
                    <div class="stat-value" id="investMonthly">0,00 ‚Ç¨</div>
                </div>
                <div class="stat-item" style="background: #e2e8f0; color: var(--text);">
                    <div class="stat-label" data-i18n="l_invest_horizon">Zeitraum (bis Amortisierung)</div>
                    <div class="stat-value" id="investHorizon">--</div>
                </div>
                <div class="stat-item" style="background: #e2e8f0; color: var(--text);">
                    <div class="stat-label" data-i18n="l_invest_break_even">Amortisiert durch Anlegen nach</div>
                    <div class="stat-value" id="investBreakEven">--</div>
                </div>
                <div class="stat-item" style="background: #e2e8f0; color: var(--text);">
                    <div class="stat-label" data-i18n="l_invest_saved">Zeitgewinn</div>
                    <div class="stat-value" id="investSaved">--</div>
                </div>
                <div class="stat-item" style="background: #e2e8f0; color: var(--text);">
                    <div class="stat-label" data-i18n="l_invest_total_paid">Eingezahlt bis dahin</div>
                    <div class="stat-value" id="investTotalPaid">0,00 ‚Ç¨</div>
                </div>
                <div class="stat-item" style="background: #e2e8f0; color: var(--text);">
                    <div class="stat-label" data-i18n="l_invest_interest">Zinsen / Wachstum bis dahin</div>
                    <div class="stat-value" id="investInterest">0,00 ‚Ç¨</div>
                </div>
            </div>

            <p class="hint" data-i18n="h_invest_note" style="margin-top: 10px;">
                Hinweis: Das ist eine grobe Modellrechnung ohne Steuern/Geb√ºhren. Wenn deine Ersparnis ‚â§ 0 ist, wird 0 ‚Ç¨ angelegt.
            </p>
        </div>
    </div>
</div>

<div id="dareModal" class="modal-backdrop" role="dialog" aria-modal="true" aria-labelledby="dareTitle">
    <div class="modal">
        <div id="dareTitle" class="modal-title">I DARE YOU DOING THAT.</div>
        <div id="dareBody" style="white-space: pre-wrap;"></div>
        <div class="modal-actions">
            <button type="button" id="dareCancel" class="icon-button">Okay okay‚Ä¶ ich bin brav</button>
            <button type="button" id="dareConfirm" class="icon-button">Close your eyes ‚Äì continue anyway</button>
        </div>
    </div>
</div>

<script>
(function() {
    'use strict';

    // --- DATEN ---
    const translations = {
        de: {
            title: "üè† Server / VPS ROI Rechner",
            h_hardware: "1. Investition (Einmalig)",
            l_base: "Hardware (Server / PC / Box)",
            h_base_hint: "Hardwarekosten oder Kaufpreis Box",
            l_setup_fee: "Setup Geb√ºhr (Einmalig)",
            l_vps_only: "Nur VPS (Keine Hardware)",
            h_setup_hint: "Einrichtungsgeb√ºhr f√ºr VPS oder Dienst",
            l_storage: "Festplatten (Optional)",
            l_size: "Gr√∂√üe (TB)",
            l_price: "Preis",
            l_count: "Anz.",
            h_power: "2. Laufende Kosten (Monatlich)",
            l_watts: "Strom (Watt & Preis/kWh)",
            l_power_cost: "Strom",
            l_services_head: "Infrastruktur & Services (Monatlich)",
            col_month: "Monat",
            col_year: "Jahr",
            l_vps_cost: "VPS / Hosting",
            l_internet_cost: "Internet / ISP",
            l_vpn_cost: "VPN",
            l_usenet_cost: "Usenet Prov.",
            l_indexer_cost: "Indexer",
            h_services_hint: "Falls Jahresabo: Preis durch 12 teilen.",
            l_total_opex: "Summe Ausgaben monatlich",
            h_subs: "3. Eingesparte Abos",
            h_subs_hint: "Dienste, die ersetzt werden.",
            l_custom_sub: "Sonstige Ersparnis (Manuell)",
            l_sum_subs: "Summe Abos:",
            h_income: "4. Einnahmen (Pssst‚Ä¶)",
            h_income_hint: "Wenn du jetzt 'Plex verkaufen' anklickst: ich urteile nicht. Also doch. Ein bisschen.",
            l_sum_income: "Summe Einnahmen:",
            l_persons: "Pers.",
            h_invest: "5. Ersparnis anlegen (Zinseszins)",
            h_invest_hint: "Rechnet: Wenn du die monatliche Ersparnis (aus 'Ergebnis') zus√§tzlich monatlich anlegst.",
            l_invest_rate: "Wachstum p.a. (%)",
            l_invest_monthly: "Monatliche Anlage (aus Ersparnis)",
            l_invest_total_paid: "Eingezahlt gesamt",
            l_invest_horizon: "Zeitraum (bis Amortisierung)",
            l_invest_break_even: "Amortisiert durch Anlegen nach",
            l_invest_saved: "Zeitgewinn",
            l_invest_interest: "Zinsen / Wachstum bis dahin",
            h_invest_note: "Hinweis: Das ist eine grobe Modellrechnung ohne Steuern/Geb√ºhren. Wenn deine Ersparnis ‚â§ 0 ist, wird 0 ‚Ç¨ angelegt.",
            h_result: "Ergebnis",
            r_intro: "Amortisiert nach:",
            r_total_invest: "Gesamt Investition",
            r_monthly_profit: "Monatliche Ersparnis (Netto)",
            verdict_loss: "Verlustgesch√§ft: Die Kosten sind h√∂her als die Ersparnis.",
            verdict_immediate: "Sofort rentabel! (Keine Investitionskosten)",
            verdict_long: "Lange Amortisationszeit (> 5 Jahre).",
            verdict_win: "Lohnt sich!",
            btn_details_show: "Detailkalkulation",
            btn_details_hide: "Detailkalkulation ausblenden",
            btn_add_hdd: "+ Festplatte",
            btn_remove_hdd: "Entfernen",
            btn_clear_hdd: "Leeren",
            l_hw_cpu: "CPU",
            l_hw_ram: "RAM",
            l_hw_board: "Mainboard",
            l_hw_psu: "Netzteil",
            l_hw_case: "Geh√§use",
            l_hw_misc: "Sonstiges",
            l_hw_total: "Summe Hardware-Details",
            modal_title: "Moment mal, Pirat.",
            modal_body: "Du hast gerade 'Einnahmen' aktiviert.\n\nDer ROI-Rechner muss kurz durchatmen.\n\nH√∂r mal, ich bin nur ein Taschenrechner mit Selbstachtung. Was du mit deinem Plex-Server machst, geht mich nichts an. Aber wenn du anf√§ngst, Netflix-Alternativen zu verkaufen, dann bist du nicht mehr 'Homelabber', sondern 'Angeklagter'.\n\nDas hier ist Mathematik, keine Gesch√§ftsberatung.\n\nWenn du trotzdem weitermachen willst: Tief durchatmen, Augen zu, und auf den peinlichen Button klicken.",
            modal_cancel: "Okay okay‚Ä¶ ich bin brav",
            modal_confirm: "Ich h√∂re nichts, ich sehe nichts üôà",
            never: "Niemals",
            reason_loss: "Laufende Kosten > Abo Kosten.",
            unit_months: "Monate",
            unit_years: "Jahre",
            tip_expensive: "Teuer pro TB.",
            tip_cheap: "Guter Preis pro TB.",
            tip_base: "√ò",
            immediate: "Sofort"
        },
        en: {
            title: "üè† Server / VPS ROI Calculator",
            h_hardware: "1. Investment (One-Time)",
            l_base: "Hardware (Server / Device)",
            h_base_hint: "Hardware cost or Box price",
            l_setup_fee: "Setup Fee (One-Time)",
            l_vps_only: "VPS Only (No Hardware)",
            h_setup_hint: "Setup fee for VPS or Service",
            l_storage: "Storage (Optional)",
            l_size: "Size (TB)",
            l_price: "Price",
            l_count: "Qty",
            h_power: "2. Operating Costs (Monthly)",
            l_watts: "Power (Watts & Price/kWh)",
            l_power_cost: "Power",
            l_services_head: "Infrastructure & Services (Monthly)",
            col_month: "Month",
            col_year: "Year",
            l_vps_cost: "VPS / Hosting",
            l_internet_cost: "Internet / ISP",
            l_vpn_cost: "VPN",
            l_usenet_cost: "Usenet Prov.",
            l_indexer_cost: "Indexer",
            h_services_hint: "For yearly subs, divide price by 12.",
            l_total_opex: "Total Monthly Expenses",
            h_subs: "3. Savings (Subscriptions)",
            h_subs_hint: "Services being replaced.",
            l_custom_sub: "Other Savings (Manual)",
            l_sum_subs: "Total Subs:",
            h_income: "4. Income (Pssst‚Ä¶)",
            h_income_hint: "If you click 'sell Plex' now: I won't judge. Okay, I will. Just a little.",
            l_sum_income: "Total Income:",
            l_persons: "Ppl",
            h_invest: "5. Invest savings (compound interest)",
            h_invest_hint: "Calculates what happens if you invest the monthly net savings from the result.",
            l_invest_rate: "Growth p.a. (%)",
            l_invest_monthly: "Monthly investment (from savings)",
            l_invest_total_paid: "Total contributions",
            l_invest_horizon: "Horizon (until break-even)",
            l_invest_break_even: "Break-even by investing after",
            l_invest_saved: "Time saved",
            l_invest_interest: "Growth / interest until then",
            h_invest_note: "Note: Rough model without taxes/fees. If savings ‚â§ 0, monthly investment is 0.",
            h_result: "Result",
            r_intro: "Break-even in:",
            r_total_invest: "Total Investment",
            r_monthly_profit: "Monthly Savings (Net)",
            verdict_loss: "Loss: Running costs exceed savings.",
            verdict_immediate: "Immediately Profitable! (No CAPEX)",
            verdict_long: "Long ROI time (> 5 years).",
            verdict_win: "Worth it!",
            btn_details_show: "Show Details",
            btn_details_hide: "Hide Details",
            btn_add_hdd: "+ Add HDD",
            btn_remove_hdd: "Remove",
            btn_clear_hdd: "Clear",
            l_hw_cpu: "CPU",
            l_hw_ram: "RAM",
            l_hw_board: "Motherboard",
            l_hw_psu: "Power Supply",
            l_hw_case: "Case",
            l_hw_misc: "Miscellaneous",
            l_hw_total: "Total Hardware Details",
            modal_title: "Hold up, Captain Sparrow.",
            modal_body: "You just enabled 'Income'.\n\nThe ROI calculator needs a moment.\n\nLook, I'm just a calculator with self-respect. What you do with your Plex server is your business. But the moment you start selling Netflix alternatives, you're not a 'homelab enthusiast' anymore ‚Äì you're 'Exhibit A'.\n\nThis is math, not legal advice.\n\nIf you still want to proceed: Take a deep breath, close your eyes, and click the embarrassing button.",
            modal_cancel: "Fine fine‚Ä¶ I'll behave",
            modal_confirm: "I see nothing, I know nothing üôà",
            never: "Never",
            reason_loss: "OpEx > Savings.",
            unit_months: "months",
            unit_years: "years",
            tip_expensive: "Expensive per TB.",
            tip_cheap: "Good price per TB.",
            tip_base: "√ò",
            immediate: "Immediately"
        }
    };

    const currencies = { EUR: "‚Ç¨", USD: "$", GBP: "¬£", CHF: "Fr", INR: "‚Çπ" };

    const services = [
        { name: "Netflix (Standard)", prices: { EUR: 13.99, USD: 15.49, GBP: 10.99, CHF: 18.90, INR: 499 }, id: "netflix" },
        { name: "Netflix (4K)", prices: { EUR: 19.99, USD: 22.99, GBP: 17.99, CHF: 24.90, INR: 649 }, id: "netflix_prem" },
        { name: "Disney+", prices: { EUR: 8.99, USD: 13.99, GBP: 8.99, CHF: 12.90, INR: 299 }, id: "disney" },
        { name: "Prime Video", prices: { EUR: 8.99, USD: 8.99, GBP: 8.99, CHF: 9.90, INR: 299 }, id: "prime" },
        { name: "Spotify/Tidal", prices: { EUR: 10.99, USD: 12.99, GBP: 12.99, CHF: 15.95, INR: 119 }, id: "music" },
        { name: "HBO / Max", prices: { EUR: 9.99, USD: 15.99, GBP: 12.99, CHF: 12.99, INR: 199 }, id: "hbo" },
        { name: "Apple TV+", prices: { EUR: 9.99, USD: 9.99, GBP: 8.99, CHF: 10.90, INR: 99 }, id: "appletv" },
        { name: "Paramount+", prices: { EUR: 7.99, USD: 11.99, GBP: 6.99, CHF: 12.00, INR: 149 }, id: "paramount" },
        { name: "WOW / Sky / Now", prices: { EUR: 9.99, USD: 9.99, GBP: 9.99, CHF: 9.99, INR: 499 }, id: "wow" },
        { name: "RTL+", prices: { EUR: 6.99, USD: 6.99, GBP: 6.99, CHF: 6.99, INR: 199 }, id: "rtlplus" },
        { name: "Joyn PLUS+", prices: { EUR: 6.99, USD: 6.99, GBP: 6.99, CHF: 6.99, INR: 199 }, id: "joyn" },
        { name: "Cloud-Speicher (Google/Apple/OneDrive ‚Ä¶)", prices: { EUR: 9.99, USD: 9.99, GBP: 7.99, CHF: 10.00, INR: 130 }, id: "cloud" }
    ];

    const incomes = [
        { name: "Plex / Streaming-Share", price: 10.00, id: "plex" }
    ];

    let currentLang = 'de';
    let currentCurrency = 'EUR';
    let fxRatesLoaded = false;

    // --- LIVE FX (cached) ---
    let fxRates = { EUR: 1 };
    const FX_BASE = "EUR";
    const FX_CACHE_TTL = 1000 * 60 * 60 * 24; // 24h
    const FX_CACHE_KEY_RATES = "fxRates_v1";
    const FX_CACHE_KEY_TIME = "fxRatesTime_v1";

    // --- DOM Elements ---
    const subsContainer = document.getElementById('subsList');
    const incomeContainer = document.getElementById('incomeList');
    const hddList = document.getElementById('hddList');
    const addHddBtn = document.getElementById('addHddBtn');
    const vpsOnlyToggle = document.getElementById('vpsOnlyToggle');
    const hardwareInputsSection = document.getElementById('hardwareInputsSection');
    const wattsInput = document.getElementById('watts');
    const toggleHardwareDetailsBtn = document.getElementById('toggleHardwareDetails');
    const hardwareDetails = document.getElementById('hardwareDetails');
    const dareModal = document.getElementById('dareModal');
    const dareBody = document.getElementById('dareBody');
    const dareCancel = document.getElementById('dareCancel');
    const dareConfirm = document.getElementById('dareConfirm');

    let dareResolver = null;

    // --- FX Functions ---
    async function fetchFx(url) {
        const res = await fetch(url, { cache: "no-store" });
        if (!res.ok) throw new Error(`FX HTTP ${res.status}`);
        const data = await res.json();
        if (!data || !data.rates) throw new Error("FX invalid payload");
        return data.rates;
    }

    async function loadFxRates() {
        if (fxRatesLoaded) return;
        
        try {
            const cached = localStorage.getItem(FX_CACHE_KEY_RATES);
            const cachedTimeRaw = localStorage.getItem(FX_CACHE_KEY_TIME);
            const cachedTime = cachedTimeRaw ? parseInt(cachedTimeRaw, 10) : 0;
            if (cached && cachedTime && (Date.now() - cachedTime) < FX_CACHE_TTL) {
                fxRates = JSON.parse(cached);
                if (fxRates && typeof fxRates === "object") {
                    fxRates[FX_BASE] = 1;
                    fxRatesLoaded = true;
                    return;
                }
            }
        } catch (_) {
            // ignore cache errors
        }

        const urls = [
            "https://api.exchangerate.host/latest?base=EUR",
            "https://api.frankfurter.app/latest?from=EUR"
        ];

        for (const url of urls) {
            try {
                const rates = await fetchFx(url);
                fxRates = { EUR: 1, ...rates };
                fxRatesLoaded = true;
                try {
                    localStorage.setItem(FX_CACHE_KEY_RATES, JSON.stringify(fxRates));
                    localStorage.setItem(FX_CACHE_KEY_TIME, String(Date.now()));
                } catch (_) {
                    // ignore storage errors
                }
                return;
            } catch (e) {
                console.warn("FX fetch failed:", url, e);
            }
        }

        // final fallback: keep whatever we have (or EUR only)
        fxRates = fxRates && typeof fxRates === "object" ? fxRates : { EUR: 1 };
        fxRates[FX_BASE] = 1;
        fxRatesLoaded = true;
    }

    function convertAmount(amount, from, to) {
        if (!isFinite(amount)) return amount;
        if (!from || !to || from === to) return amount;
        
        // Guard against unloaded rates
        if (!fxRatesLoaded) {
            console.warn("FX rates not loaded yet, returning original amount");
            return amount;
        }
        
        const rFrom = fxRates?.[from];
        const rTo = fxRates?.[to];
        if (!isFinite(rFrom) || !isFinite(rTo) || rFrom <= 0 || rTo <= 0) return amount;
        const eur = amount / rFrom;
        return eur * rTo;
    }

    // --- Utility Functions ---
    function formatMoney(amount) {
        return new Intl.NumberFormat(currentLang === 'de' ? 'de-DE' : 'en-US', {
            style: 'currency', currency: currentCurrency
        }).format(amount);
    }

    function clampPositive(value) {
        const num = parseFloat(value) || 0;
        return Math.max(0, num);
    }

    function projectMonthlyInvest(monthlyContribution, annualRatePercent, months) {
        const m = Math.max(0, Math.floor(months || 0));
        const c = Math.max(0, monthlyContribution || 0);
        const r = Math.max(0, annualRatePercent || 0) / 100;
        const mr = Math.pow(1 + r, 1 / 12) - 1;

        let balance = 0;
        for (let i = 0; i < m; i++) {
            balance = balance * (1 + mr) + c;
        }
        const paid = c * m;
        const interest = balance - paid;
        return { balance, paid, interest };
    }

    function monthsToReachTarget(monthlyContribution, annualRatePercent, target, maxMonths = 2400) {
        const c = Math.max(0, monthlyContribution || 0);
        const t = Math.max(0, target || 0);
        const r = Math.max(0, annualRatePercent || 0) / 100;
        const mr = Math.pow(1 + r, 1 / 12) - 1;

        if (t <= 0) return { months: 0, balance: 0, paid: 0, interest: 0 };
        if (c <= 0) return { months: Infinity, balance: 0, paid: 0, interest: 0 };

        let balance = 0;
        let months = 0;
        while (months < maxMonths && balance < t) {
            balance = balance * (1 + mr) + c;
            months++;
        }
        const paid = c * months;
        const interest = balance - paid;
        return { months: balance >= t ? months : Infinity, balance, paid, interest };
    }

    function formatDurationMonths(months, t) {
        if (!isFinite(months)) return "‚Äî";
        const m = Math.max(0, Math.round(months));
        const years = Math.floor(m / 12);
        const rem = m % 12;
        if (years <= 0) return `${m} ${t.unit_months}`;
        if (rem <= 0) return `${years} ${t.unit_years}`;
        return `${years} ${t.unit_years} ${rem} ${t.unit_months}`;
    }

    // --- Modal Functions ---
    function openDareModal() {
        if (!dareModal) return Promise.resolve(true);
        const t = translations[currentLang];
        
        const titleEl = document.getElementById('dareTitle');
        if (titleEl) titleEl.textContent = t.modal_title;
        if (dareBody) dareBody.textContent = t.modal_body;
        if (dareCancel) dareCancel.textContent = t.modal_cancel;
        if (dareConfirm) dareConfirm.textContent = t.modal_confirm;
        
        dareModal.style.display = 'flex';

        return new Promise((resolve) => {
            dareResolver = resolve;
        });
    }

    function closeDareModal(result) {
        if (dareModal) dareModal.style.display = 'none';
        if (dareResolver) {
            dareResolver(result);
            dareResolver = null;
        }
    }

    // --- Language & Currency ---
    function updateLanguage() {
        const t = translations[currentLang];
        document.querySelectorAll('[data-i18n]').forEach(el => {
            const key = el.getAttribute('data-i18n');
            if (t[key]) el.textContent = t[key];
        });

        // Update dynamic HDD labels
        document.querySelectorAll('.hdd-row').forEach(row => {
            const labels = row.querySelectorAll('label:not(.sr-only)');
            if (labels.length >= 3) {
                labels[0].textContent = t.l_size.replace('(TB)', '').trim();
                labels[1].textContent = t.l_price;
                labels[2].textContent = t.l_count;
            }
            // Update button text
            const removeBtn = row.querySelector('.remove-hdd');
            if (removeBtn) {
                const hddCount = hddList.children.length;
                removeBtn.textContent = hddCount > 1 ? '‚àí' : '‚åÄ';
                removeBtn.title = hddCount > 1 ? t.btn_remove_hdd : t.btn_clear_hdd;
            }
        });

        // Update income person labels
        document.querySelectorAll('.income-persons-label').forEach(el => {
            el.textContent = t.l_persons;
        });

        updateCurrencySymbols();
    }

    function updateCurrencySymbols() {
        const symbol = currencies[currentCurrency];
        document.querySelectorAll('.currency-symbol').forEach(el => el.textContent = symbol);
    }

    // --- Hardware Detail Total ---
    function updateHardwareDetailTotal() {
        const ids = ['hwCpu', 'hwRam', 'hwBoard', 'hwPsu', 'hwCase', 'hwMisc'];
        let sum = 0;
        ids.forEach(id => {
            const el = document.getElementById(id);
            if (el) sum += clampPositive(el.value);
        });
        const totalSpan = document.getElementById('hwDetailTotal');
        if (totalSpan) totalSpan.textContent = formatMoney(sum);

        if (sum > 0) {
            const baseHwInput = document.getElementById('baseHardware');
            if (baseHwInput) {
                baseHwInput.value = sum.toFixed(2);
            }
        }
        calculate();
    }

    // --- HDD Row Management ---
    function updateHddButtons() {
        const t = translations[currentLang];
        const rows = hddList.querySelectorAll('.hdd-row');
        rows.forEach(row => {
            const removeBtn = row.querySelector('.remove-hdd');
            if (removeBtn) {
                const isOnlyRow = rows.length === 1;
                removeBtn.textContent = isOnlyRow ? '‚åÄ' : '‚àí';
                removeBtn.title = isOnlyRow ? t.btn_clear_hdd : t.btn_remove_hdd;
            }
        });
    }

    function addHddRow(size = 0, price = 0, count = 1) {
        const t = translations[currentLang];
        const rowId = 'hdd_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        const row = document.createElement('div');
        row.className = 'hdd-row';
        row.dataset.rowId = rowId;
        
        row.innerHTML = `
            <div class="col">
                <label for="${rowId}_size" style="font-size: 0.8rem">${t.l_size.replace('(TB)', '').trim()}</label>
                <input type="number" id="${rowId}_size" class="hdd-size" value="${size}" min="0" step="0.1" aria-label="Festplattengr√∂√üe in TB">
            </div>
            <div class="col">
                <label for="${rowId}_price" style="font-size: 0.8rem">${t.l_price}</label>
                <input type="number" id="${rowId}_price" class="hdd-price" value="${price}" min="0" step="0.01" data-money="1" aria-label="Festplattenpreis">
            </div>
            <div class="col-small">
                <label for="${rowId}_count" style="font-size: 0.8rem">${t.l_count}</label>
                <input type="number" id="${rowId}_count" class="hdd-count" value="${count}" min="0" step="1" aria-label="Anzahl Festplatten">
            </div>
            <button type="button" class="icon-button small remove-hdd" title="${t.btn_remove_hdd}">‚àí</button>
        `;

        // Use event delegation pattern for cleaner cleanup
        const handleInput = () => calculate();
        const handleRemove = () => {
            if (hddList.children.length > 1) {
                row.remove();
                updateHddButtons();
                calculate();
            } else {
                row.querySelectorAll('input').forEach(input => input.value = 0);
                calculate();
            }
        };

        row.querySelectorAll('input').forEach(input => {
            input.addEventListener('input', handleInput);
        });
        row.querySelector('.remove-hdd').addEventListener('click', handleRemove);
        
        hddList.appendChild(row);
        updateHddButtons();
    }

    // --- Build Subscriptions List ---
    function buildSubsList() {
        subsContainer.innerHTML = '';
        services.forEach(service => {
            const div = document.createElement('div');
            div.className = 'sub-item';
            const price = service.prices[currentCurrency] || service.prices['EUR'];
            const checkboxId = `cb_${service.id}`;
            
            div.innerHTML = `
                <div class="sub-left">
                    <input type="checkbox" id="${checkboxId}" class="sub-checkbox">
                    <label for="${checkboxId}" style="margin:0; font-weight: normal;">${service.name}</label>
                </div>
                <div class="sub-price-wrapper">
                    <label for="price_${service.id}" class="sr-only">Preis f√ºr ${service.name}</label>
                    <input type="number" id="price_${service.id}" class="sub-price-input" value="${price}" min="0" step="0.01" data-money="1" data-service-id="${service.id}">
                    <span class="currency-symbol">${currencies[currentCurrency]}</span>
                </div>
            `;
            
            div.querySelectorAll('input').forEach(input => {
                input.addEventListener('input', calculate);
                input.addEventListener('change', calculate);
            });
            
            subsContainer.appendChild(div);
        });
    }

    // --- Build Income List ---
    function buildIncomeList() {
        incomeContainer.innerHTML = '';
        const t = translations[currentLang];
        
        incomes.forEach(income => {
            const div = document.createElement('div');
            div.className = 'sub-item income-item';
            const checkboxId = `inc_${income.id}`;
            const countId = `inc_count_${income.id}`;
            const priceId = `inc_price_${income.id}`;
            const currencyId = `inc_curr_${income.id}`;
            
            div.innerHTML = `
                <div class="sub-left">
                    <input type="checkbox" id="${checkboxId}" class="income-checkbox">
                    <label for="${checkboxId}" style="margin:0; font-weight: normal;">${income.name}</label>
                </div>
                <div class="sub-price-wrapper">
                    <label for="${countId}" class="sr-only">Anzahl Personen</label>
                    <input type="number" id="${countId}" class="income-count-input sub-count-input" value="1" min="0" step="1">
                    <span class="income-persons-label" style="font-size:0.8rem; color:#64748b;">${t.l_persons}</span>
                    <label for="${priceId}" class="sr-only">Preis pro Person</label>
                    <input type="number" id="${priceId}" class="income-price-input sub-price-input" value="${income.price}" min="0" step="0.01">
                    <label for="${currencyId}" class="sr-only">W√§hrung f√ºr Einnahmen</label>
                    <select id="${currencyId}" class="income-currency-select" style="width: auto; padding: 2px; font-size: 0.8rem; height: auto; margin-left: 5px;">
                        <option value="EUR">‚Ç¨</option>
                        <option value="USD">$</option>
                        <option value="GBP">¬£</option>
                        <option value="CHF">Fr</option>
                        <option value="INR">‚Çπ</option>
                    </select>
                </div>
            `;
            
            const checkbox = div.querySelector('.income-checkbox');
            const currencySelect = div.querySelector('.income-currency-select');
            currencySelect.value = currentCurrency;

            checkbox.addEventListener('change', () => {
                if (checkbox.checked) {
                    openDareModal().then((ok) => {
                        if (!ok) checkbox.checked = false;
                        calculate();
                    });
                    return;
                }
                calculate();
            });
            
            div.querySelectorAll('input, select').forEach(input => {
                if (input !== checkbox) {
                    input.addEventListener('input', calculate);
                    input.addEventListener('change', calculate);
                }
            });
            
            incomeContainer.appendChild(div);
        });
    }

    // --- Main Calculate Function ---
    function calculate() {
        const t = translations[currentLang];

        // 1. INVESTITION
        const baseHw = clampPositive(document.getElementById('baseHardware').value);
        const setupFee = clampPositive(document.getElementById('setupFee').value);
        let totalHddCost = 0;
        let totalHddSize = 0;
        
        document.querySelectorAll('.hdd-row').forEach(row => {
            const size = clampPositive(row.querySelector('.hdd-size').value);
            const price = clampPositive(row.querySelector('.hdd-price').value);
            const count = clampPositive(row.querySelector('.hdd-count').value);
            if (price > 0 && count > 0) {
                totalHddCost += price * count;
            }
            if (size > 0 && price > 0 && count > 0) {
                totalHddSize += size * count;
            }
        });

        const totalInvest = baseHw + setupFee + totalHddCost;

        // TB Skalierung
        const scaleDiv = document.getElementById('storageScaling');
        if (totalHddSize > 0 && totalHddCost > 0) {
            scaleDiv.style.display = 'block';
            const tbPrice = (totalHddCost / totalHddSize);
            let scaleText = `${t.tip_base} ${formatMoney(tbPrice).replace(currencies[currentCurrency], '').trim()} / TB.`;
            if (tbPrice > 25) scaleText += ` <span style="color:#d97706">${t.tip_expensive}</span>`;
            else if (tbPrice < 17) scaleText += ` <span style="color:#16a34a">${t.tip_cheap}</span>`;
            scaleDiv.innerHTML = scaleText;
        } else if (scaleDiv) {
            scaleDiv.style.display = 'none';
        }

        // 2. AUSGABEN (OPEX)
        const watts = clampPositive(document.getElementById('watts').value);
        const kwhPrice = clampPositive(document.getElementById('kwhPrice').value);
        
        let vpsMonthly = clampPositive(document.getElementById('vpsMonthly').value);
        let internetCost = clampPositive(document.getElementById('internetCost').value);
        let vpnCost = clampPositive(document.getElementById('vpnCost').value);
        let usenetCost = clampPositive(document.getElementById('usenetCost').value);
        let indexerCost = clampPositive(document.getElementById('indexerCost').value);

        const vpsYearly = clampPositive(document.getElementById('vpsYearly').value);
        const internetYearly = clampPositive(document.getElementById('internetYearly').value);
        const vpnYearly = clampPositive(document.getElementById('vpnYearly').value);
        const usenetYearly = clampPositive(document.getElementById('usenetYearly').value);
        const indexerYearly = clampPositive(document.getElementById('indexerYearly').value);

        if (vpsYearly > 0) vpsMonthly = vpsYearly / 12;
        if (internetYearly > 0) internetCost = internetYearly / 12;
        if (vpnYearly > 0) vpnCost = vpnYearly / 12;
        if (usenetYearly > 0) usenetCost = usenetYearly / 12;
        if (indexerYearly > 0) indexerCost = indexerYearly / 12;

        const monthlyPower = (watts / 1000) * 24 * 30 * kwhPrice;
        const totalMonthlyOut = monthlyPower + vpsMonthly + internetCost + vpnCost + usenetCost + indexerCost;

        // FIX: i18n for power cost display
        document.getElementById('powerCostDisplay').innerHTML = `${t.l_power_cost}: ${formatMoney(monthlyPower)}`;

        // 3. ERSPARNIS
        let subSum = 0;
        document.querySelectorAll('.sub-item:not(.income-item)').forEach(item => {
            const checkbox = item.querySelector('.sub-checkbox');
            const priceInput = item.querySelector('.sub-price-input');
            if (checkbox && checkbox.checked && priceInput) {
                subSum += clampPositive(priceInput.value);
            }
        });
        subSum += clampPositive(document.getElementById('customSub').value);

        // 3b. EINNAHMEN
        let incomeSum = 0;
        document.querySelectorAll('.income-item').forEach(item => {
            const checkbox = item.querySelector('.income-checkbox');
            if (checkbox && checkbox.checked) {
                let price = clampPositive(item.querySelector('.income-price-input')?.value);
                const count = clampPositive(item.querySelector('.income-count-input')?.value);
                const incomeCurrency = item.querySelector('.income-currency-select')?.value || currentCurrency;
                
                if (incomeCurrency !== currentCurrency && fxRatesLoaded) {
                    price = convertAmount(price, incomeCurrency, currentCurrency);
                }
                
                incomeSum += price * count;
            }
        });

        // 4. ERGEBNIS
        const monthlyProfit = subSum + incomeSum - totalMonthlyOut;
        
        document.getElementById('totalInvest').textContent = formatMoney(totalInvest);
        document.getElementById('totalMonthlyOut').textContent = formatMoney(totalMonthlyOut);
        document.getElementById('totalSubs').textContent = formatMoney(subSum);
        document.getElementById('totalIncome').textContent = formatMoney(incomeSum);
        
        const profitEl = document.getElementById('monthlyProfit');
        profitEl.textContent = formatMoney(monthlyProfit);
        profitEl.className = 'stat-value ' + (monthlyProfit > 0 ? 'positive' : 'negative');

        // 5. ERSPARNIS ANLEGEN (ZINSESZINS)
        const investRate = clampPositive(document.getElementById('investRate')?.value);
        const investMonthly = Math.max(0, monthlyProfit);

        const investMonthlyEl = document.getElementById('investMonthly');
        const investHorizonEl = document.getElementById('investHorizon');
        const investBreakEvenEl = document.getElementById('investBreakEven');
        const investSavedEl = document.getElementById('investSaved');
        const investPaidEl = document.getElementById('investTotalPaid');
        const investInterestEl = document.getElementById('investInterest');

        if (investMonthlyEl) investMonthlyEl.textContent = formatMoney(investMonthly);

        const baseReach = monthsToReachTarget(investMonthly, 0, totalInvest, 2400);
        const baseMonths = baseReach.months;

        if (!isFinite(baseMonths) || baseMonths <= 0) {
            if (investHorizonEl) investHorizonEl.textContent = "‚Äî";
            if (investBreakEvenEl) investBreakEvenEl.textContent = "‚Äî";
            if (investSavedEl) investSavedEl.textContent = "‚Äî";
            if (investPaidEl) investPaidEl.textContent = formatMoney(0);
            if (investInterestEl) investInterestEl.textContent = formatMoney(0);
        } else {
            if (investHorizonEl) investHorizonEl.textContent = formatDurationMonths(baseMonths, t);

            const reach = monthsToReachTarget(investMonthly, investRate, totalInvest, 2400);
            if (investBreakEvenEl) investBreakEvenEl.textContent = formatDurationMonths(reach.months, t);

            const saved = (isFinite(reach.months) && isFinite(baseMonths)) ? (baseMonths - reach.months) : 0;
            if (investSavedEl) {
                investSavedEl.textContent = (isFinite(reach.months) && saved > 0)
                    ? `${Math.round(saved)} ${t.unit_months}`
                    : `0 ${t.unit_months}`;
            }

            if (investPaidEl) investPaidEl.textContent = formatMoney(reach.paid || 0);
            if (investInterestEl) investInterestEl.textContent = formatMoney(reach.interest || 0);
        }

        const resultTime = document.getElementById('amortizationTime');
        const resultDate = document.getElementById('amortizationDate');
        const verdict = document.getElementById('verdict');

        if (monthlyProfit <= 0) {
            resultTime.textContent = t.never;
            resultDate.textContent = t.reason_loss;
            verdict.textContent = t.verdict_loss;
            verdict.style.color = "#fca5a5";
        } else if (totalInvest <= 0) {
            resultTime.textContent = t.immediate;
            resultDate.textContent = "";
            verdict.textContent = t.verdict_immediate;
            verdict.style.color = "#86efac";
        } else {
            const monthsToBreakEven = totalInvest / monthlyProfit;
            const years = Math.floor(monthsToBreakEven / 12);
            const remainingMonths = Math.round(monthsToBreakEven % 12);
            
            resultTime.textContent = `${monthsToBreakEven.toFixed(1)} ${t.unit_months}`;
            
            let timeString = "";
            if (years > 0) timeString += `${years} ${t.unit_years} `;
            if (remainingMonths > 0) timeString += `${remainingMonths} ${t.unit_months}`;
            
            resultDate.textContent = `~ ${timeString}`;
            
            if (monthsToBreakEven > 60) {
                verdict.textContent = t.verdict_long;
                verdict.style.color = "#fbbf24";
            } else {
                verdict.textContent = t.verdict_win;
                verdict.style.color = "#86efac";
            }
        }
    }

    // --- Event Listeners Setup ---
    function setupEventListeners() {
        // Language selector
        document.getElementById('langSelect').addEventListener('change', (e) => {
            currentLang = e.target.value;
            updateLanguage();
            calculate();
        });

        // Currency selector
        document.getElementById('currSelect').addEventListener('change', async (e) => {
            const newCurrency = e.target.value;
            const oldCurrency = currentCurrency;
            if (newCurrency === oldCurrency) return;

            await loadFxRates();

            document.querySelectorAll('input[data-money="1"]').forEach(input => {
                if (!input || input.value === "") return;
                const val = parseFloat(input.value);
                if (!isFinite(val)) return;

                const serviceId = input.getAttribute('data-service-id');
                if (serviceId) {
                    const service = services.find(s => s.id === serviceId);
                    if (service && service.prices[newCurrency]) {
                        input.value = service.prices[newCurrency].toFixed(2);
                        return;
                    }
                }

                const converted = convertAmount(val, oldCurrency, newCurrency);
                input.value = isFinite(converted) ? converted.toFixed(2) : input.value;
            });

            currentCurrency = newCurrency;
            updateCurrencySymbols();
            calculate();
        });

        // VPS Only Toggle
        if (vpsOnlyToggle) {
            vpsOnlyToggle.addEventListener('change', () => {
                const isVpsOnly = vpsOnlyToggle.checked;
                if (isVpsOnly) {
                    document.getElementById('baseHardware').value = 0;
                    ['hwCpu', 'hwRam', 'hwBoard', 'hwPsu', 'hwCase', 'hwMisc'].forEach(id => {
                        const el = document.getElementById(id);
                        if (el) el.value = 0;
                    });
                    updateHardwareDetailTotal();

                    const hddRows = document.querySelectorAll('.hdd-row');
                    hddRows.forEach((row, index) => {
                        if (index === 0) {
                            row.querySelectorAll('input').forEach(input => input.value = 0);
                        } else {
                            row.remove();
                        }
                    });
                    updateHddButtons();

                    if (wattsInput) wattsInput.value = 0;

                    if (hardwareInputsSection) {
                        hardwareInputsSection.style.opacity = '0.5';
                        hardwareInputsSection.style.pointerEvents = 'none';
                    }
                } else {
                    if (hardwareInputsSection) {
                        hardwareInputsSection.style.opacity = '1';
                        hardwareInputsSection.style.pointerEvents = 'auto';
                    }
                }
                calculate();
            });
        }

        // Hardware Details Toggle
        if (toggleHardwareDetailsBtn && hardwareDetails) {
            toggleHardwareDetailsBtn.addEventListener('click', () => {
                const isHidden = hardwareDetails.style.display === 'none' || hardwareDetails.style.display === '';
                hardwareDetails.style.display = isHidden ? 'block' : 'none';
                const t = translations[currentLang];
                toggleHardwareDetailsBtn.textContent = isHidden ? t.btn_details_hide : t.btn_details_show;
            });
            
            ['hwCpu', 'hwRam', 'hwBoard', 'hwPsu', 'hwCase', 'hwMisc'].forEach(id => {
                const el = document.getElementById(id);
                if (el) el.addEventListener('input', updateHardwareDetailTotal);
            });
        }

        // Add HDD Button
        addHddBtn.addEventListener('click', () => addHddRow());

        // Modal events
        if (dareCancel) dareCancel.addEventListener('click', () => closeDareModal(false));
        if (dareConfirm) dareConfirm.addEventListener('click', () => closeDareModal(true));
        if (dareModal) {
            dareModal.addEventListener('click', (e) => {
                if (e.target === dareModal) closeDareModal(false);
            });
        }

        // Generic input listeners for remaining inputs
        const inputIds = ['baseHardware', 'setupFee', 'watts', 'kwhPrice', 
                         'vpsMonthly', 'vpsYearly', 'internetCost', 'internetYearly',
                         'vpnCost', 'vpnYearly', 'usenetCost', 'usenetYearly',
                         'indexerCost', 'indexerYearly', 'customSub', 'investRate'];
        
        inputIds.forEach(id => {
            const el = document.getElementById(id);
            if (el) el.addEventListener('input', calculate);
        });
    }

    // --- Initialization ---
    async function init() {
        await loadFxRates();
        buildSubsList();
        buildIncomeList();
        addHddRow(0, 0, 1);
        setupEventListeners();
        updateLanguage();
        calculate();
    }

    // Start
    init();
})();
</script>

</body>
</html>